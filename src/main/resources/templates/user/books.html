<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitap Kataloğu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/variables.css}">
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/books.css}">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="/member">
            <i class="fas fa-book-reader me-2"></i>AKYS Üye
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link active" href="/view/books"><i class="fas fa-book me-1"></i>Kitaplar</a></li>
                <li class="nav-item"><a class="nav-link" href="/view/my-loans"><i class="fas fa-hand-holding me-1"></i>Ödünçlerim</a></li>
                <li class="nav-item"><a class="nav-link" href="/view/my-reservations"><i class="fas fa-clock me-1"></i>Rezervasyonlarım</a></li>
                <li class="nav-item"><a class="nav-link" href="/view/profile"><i class="fas fa-user me-1"></i>Profil</a></li>
                <li class="nav-item"><a class="nav-link" href="/logout"><i class="fas fa-sign-out-alt me-1"></i>Çıkış</a></li>
            </ul>
        </div>
    </div>
</nav>

<main class="container py-5">
    <div class="books-header">
        <h1 class="display-6 fw-bold mb-2">
            <i class="fas fa-book-open me-2"></i>Kitap Kataloğu
        </h1>
        <p class="text-light opacity-75 mb-0">Mevcut kitapları incele ve uygun olanları ödünç al.</p>
    </div>

    <div class="search-filter-bar">
        <div class="row g-3">
            <div class="col-md-8">
                <div class="input-group">
                    <span class="input-group-text" style="background: var(--bg-dark); border: 1px solid var(--border); color: var(--text-light);">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" class="form-control search-input" id="searchInput" 
                           placeholder="Kitap adı, yazar veya kategori ile ara...">
                </div>
            </div>
            <div class="col-md-4">
                <select class="form-select search-input" id="availabilityFilter">
                    <option value="all">Tüm Kitaplar</option>
                    <option value="available">Sadece Uygun Olanlar</option>
                    <option value="unavailable">Uygun Olmayanlar</option>
                </select>
            </div>
        </div>
    </div>

    <div class="row g-4" id="booksGrid">
        <div class="col-md-6 col-lg-4 col-xl-3" th:each="b : ${books}" th:attr="data-title=${b.title}, data-authors=${#strings.listJoin(b.authors.![name], ', ')}, data-categories=${#strings.listJoin(b.categories.![name], ', ')}, data-available=${b.availableCopies > 0}">
            <div class="book-card">
                <div class="book-cover-container">
                    <img th:if="${b.coverImageUrl != null and !#strings.isEmpty(b.coverImageUrl)}" 
                         th:src="${b.coverImageUrl}" 
                         th:alt="${b.title}"
                         class="book-cover"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="book-cover-placeholder" style="display: none;">
                        <i class="fas fa-book"></i>
                    </div>
                    <div th:if="${b.coverImageUrl == null or #strings.isEmpty(b.coverImageUrl)}" class="book-cover-placeholder">
                        <i class="fas fa-book"></i>
                    </div>
                </div>
                <div class="book-card-body">
                    <h5 class="book-title" th:text="${b.title}">Kitap Başlığı</h5>
                    <div class="book-authors">
                        <i class="fas fa-user-edit me-1" style="color: rgba(255, 255, 255, 0.5);"></i>
                        <span th:if="${!b.authors.isEmpty()}">
                            <span th:each="author, iterStat : ${b.authors}">
                                <span th:text="${author.name}"></span><span th:if="${!iterStat.last}">, </span>
                            </span>
                        </span>
                        <span th:if="${b.authors.isEmpty()}">Yazar bilgisi yok</span>
                    </div>
                    <div class="book-categories" th:if="${!b.categories.isEmpty()}">
                        <span th:each="category : ${b.categories}">
                            <span class="category-badge" th:text="${category.name}"></span>
                        </span>
                    </div>
                    <div class="book-meta">
                        <div>
                            <span class="availability-badge" 
                                  th:classappend="${b.availableCopies > 0 ? 'available' : 'unavailable'}">
                                <i class="fas" th:classappend="${b.availableCopies > 0 ? 'fa-check-circle' : 'fa-times-circle'}" th:class="${b.availableCopies > 0 ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                                <span th:text="${b.availableCopies + ' / ' + b.totalCopies}"></span>
                            </span>
                        </div>
                    </div>
                    <form sec:authorize="hasAnyRole('ADMIN','MEMBER')" method="post" action="/view/borrow" class="mt-auto">
                        <input type="hidden" name="bookId" th:value="${b.id}">
                        <button class="btn btn-primary book-action-btn" type="submit" th:disabled="${b.availableCopies == 0}">
                            <i class="fas fa-hand-holding me-2"></i>
                            <span th:text="${b.availableCopies > 0 ? 'Ödünç Al' : 'Uygun Değil'}"></span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="empty-state" id="noResults" style="display: none;">
        <div class="empty-state-icon">
            <i class="fas fa-search"></i>
        </div>
        <h4>Sonuç bulunamadı</h4>
        <p>Arama kriterlerinize uygun kitap bulunamadı.</p>
    </div>

    <div class="empty-state" th:if="${#lists.isEmpty(books)}">
        <div class="empty-state-icon">
            <i class="fas fa-inbox"></i>
        </div>
        <h4>Henüz kitap yok</h4>
        <p>Kütüphanede henüz kitap bulunmuyor.</p>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Search and filter functionality
    const searchInput = document.getElementById('searchInput');
    const availabilityFilter = document.getElementById('availabilityFilter');
    const booksGrid = document.getElementById('booksGrid');
    const noResults = document.getElementById('noResults');
    
    function filterBooks() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const availability = availabilityFilter.value;
        const bookCards = booksGrid.querySelectorAll('.col-md-6');
        let visibleCount = 0;
        
        bookCards.forEach(card => {
            const title = card.getAttribute('data-title')?.toLowerCase() || '';
            const authors = card.getAttribute('data-authors')?.toLowerCase() || '';
            const categories = card.getAttribute('data-categories')?.toLowerCase() || '';
            const isAvailable = card.getAttribute('data-available') === 'true';
            
            const matchesSearch = !searchTerm || 
                title.includes(searchTerm) || 
                authors.includes(searchTerm) || 
                categories.includes(searchTerm);
            
            const matchesAvailability = availability === 'all' ||
                (availability === 'available' && isAvailable) ||
                (availability === 'unavailable' && !isAvailable);
            
            if (matchesSearch && matchesAvailability) {
                card.style.display = '';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });
        
        // Show/hide no results message
        if (visibleCount === 0 && bookCards.length > 0) {
            noResults.style.display = 'block';
        } else {
            noResults.style.display = 'none';
        }
    }
    
    searchInput.addEventListener('input', filterBooks);
    availabilityFilter.addEventListener('change', filterBooks);
    
    // Handle image load errors
    document.querySelectorAll('.book-cover').forEach(img => {
        img.addEventListener('error', function() {
            this.style.display = 'none';
            const placeholder = this.nextElementSibling;
            if (placeholder && placeholder.classList.contains('book-cover-placeholder')) {
                placeholder.style.display = 'flex';
            }
        });
    });
</script>
</body>
</html>
