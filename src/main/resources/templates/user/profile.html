<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profilim</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/variables.css}">
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/profile.css}">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="/member">
            <i class="fas fa-book-reader me-2"></i>AKYS Üye
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="/view/books"><i class="fas fa-book me-1"></i>Kitaplar</a></li>
                <li class="nav-item"><a class="nav-link" href="/view/my-loans"><i class="fas fa-hand-holding me-1"></i>Ödünçlerim</a></li>
                <li class="nav-item"><a class="nav-link" href="/view/my-reservations"><i class="fas fa-clock me-1"></i>Rezervasyonlarım</a></li>
                <li class="nav-item"><a class="nav-link active" href="/view/profile"><i class="fas fa-user me-1"></i>Profil</a></li>
                <li class="nav-item"><a class="nav-link" href="/logout"><i class="fas fa-sign-out-alt me-1"></i>Çıkış</a></li>
            </ul>
        </div>
    </div>
</nav>

<main class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div th:if="${param.success}" class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>Profil başarıyla güncellendi!
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i><span th:text="${error}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <div class="card-modern">
                <div class="profile-header">
                    <div class="profile-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    <h2 class="fw-bold mb-1" th:text="${me.fullName}">Kullanıcı Adı</h2>
                    <p class="text-light opacity-75 mb-0" th:text="${me.email}">email@example.com</p>
                </div>
                <div class="card-body p-0">
                    <div class="info-item">
                        <div class="info-icon">
                            <i class="fas fa-id-card"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="text-light opacity-75 small">Ad Soyad</div>
                            <div class="fw-semibold" th:text="${me.fullName}"></div>
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="text-light opacity-75 small">Email</div>
                            <div class="fw-semibold" th:text="${me.email}"></div>
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-icon">
                            <i class="fas fa-user-shield"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="text-light opacity-75 small">Rol</div>
                            <div class="fw-semibold" th:text="${me.role}"></div>
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="text-light opacity-75 small">Hesap Durumu</div>
                            <div class="fw-semibold" th:text="${me.accountStatus}"></div>
                        </div>
                    </div>
                    <div class="info-item" th:if="${me.phone != null}">
                        <div class="info-icon">
                            <i class="fas fa-phone"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="text-light opacity-75 small">Telefon</div>
                            <div class="fw-semibold" th:text="${formattedPhone}"></div>
                        </div>
                    </div>
                    <div class="info-item" th:if="${me.createdAt != null}">
                        <div class="info-icon">
                            <i class="fas fa-calendar"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="text-light opacity-75 small">Hesap Oluşturulma Tarihi</div>
                            <div class="fw-semibold" th:text="${formattedCreatedAt}"></div>
                        </div>
                    </div>
                </div>
                <div class="card-footer p-3 text-center border-top" style="border-color: var(--border) !important;">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                        <i class="fas fa-edit me-2"></i>Profili Düzenle
                    </button>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: var(--bg-card); border: 1px solid var(--border); color: var(--text-light);">
            <div class="modal-header border-bottom" style="border-color: var(--border) !important;">
                <h5 class="modal-title" id="editProfileModalLabel">Profili Düzenle</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editProfileForm" method="post" action="/view/profile/update">
                <div class="modal-body">
                    <div id="profileError" class="alert alert-danger d-none" role="alert"></div>
                    <div id="profileSuccess" class="alert alert-success d-none" role="alert"></div>
                    
                    <div class="mb-3">
                        <label for="editFullName" class="form-label">Ad Soyad</label>
                        <input type="text" class="form-control" id="editFullName" name="fullName" 
                               th:value="${me.fullName}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editPhone" class="form-label">Telefon</label>
                        <div class="input-group">
                            <span class="input-group-text" style="border-right: none;">+90</span>
                            <input type="tel" class="form-control" id="editPhone" name="phone" 
                                   placeholder="123 456 78 90" maxlength="17"
                                   th:data-existing-phone="${me.phone}"
                                   style="border-left: none; padding-left: 0;">
                        </div>
                        <small class="text-muted">10 haneli telefon numaranızı giriniz (örn: 123 456 78 90)</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editPassword" class="form-label">Yeni Parola (Değiştirmek istemiyorsanız boş bırakın)</label>
                        <input type="password" class="form-control" id="editPassword" name="password">
                        <small class="text-muted">Parola en az 6 karakter olmalıdır.</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editPasswordConfirm" class="form-label">Yeni Parola (Tekrar)</label>
                        <input type="password" class="form-control" id="editPasswordConfirm" name="passwordConfirm">
                    </div>
                </div>
                <div class="modal-footer border-top" style="border-color: var(--border) !important;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function formatPhoneNumber(value) {
        const digits = value.replace(/\D/g, '');
        
        const limitedDigits = digits.slice(0, 10);
        
        if (limitedDigits.length <= 3) {
            return limitedDigits;
        } else if (limitedDigits.length <= 6) {
            return limitedDigits.slice(0, 3) + ' ' + limitedDigits.slice(3);
        } else if (limitedDigits.length <= 8) {
            return limitedDigits.slice(0, 3) + ' ' + limitedDigits.slice(3, 6) + ' ' + limitedDigits.slice(6);
        } else {
            return limitedDigits.slice(0, 3) + ' ' + limitedDigits.slice(3, 6) + ' ' + limitedDigits.slice(6, 8) + ' ' + limitedDigits.slice(8);
        }
    }
    
    const editPhoneInput = document.getElementById('editPhone');
    const existingPhone = editPhoneInput.getAttribute('data-existing-phone') || '';
    
    if (existingPhone) {
        let phoneDigits = existingPhone.replace(/\D/g, '');

        if (phoneDigits.startsWith('90') && phoneDigits.length === 12) {
            phoneDigits = phoneDigits.substring(2);
        } else if (phoneDigits.startsWith('0') && phoneDigits.length === 11) {
            phoneDigits = phoneDigits.substring(1);
        }
        if (phoneDigits.length === 10) {
            editPhoneInput.value = formatPhoneNumber(phoneDigits);
        }
    }
    
    editPhoneInput.addEventListener('input', function(e) {
        const formatted = formatPhoneNumber(e.target.value);
        e.target.value = formatted;
    });
    
    editPhoneInput.addEventListener('blur', function(e) {
        const digits = e.target.value.replace(/\D/g, '');
        if (digits.length > 0 && digits.length !== 10) {
            e.target.setCustomValidity('Telefon numarası 10 haneli olmalıdır.');
        } else {
            e.target.setCustomValidity('');
        }
    });
    
    document.getElementById('editProfileForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const password = document.getElementById('editPassword').value;
        const passwordConfirm = document.getElementById('editPasswordConfirm').value;
        const errorDiv = document.getElementById('profileError');
        const successDiv = document.getElementById('profileSuccess');
        
        errorDiv.classList.add('d-none');
        successDiv.classList.add('d-none');
        
        if (password) {
            if (password.length < 6) {
                errorDiv.textContent = 'Parola en az 6 karakter olmalıdır.';
                errorDiv.classList.remove('d-none');
                return;
            }
            if (password !== passwordConfirm) {
                errorDiv.textContent = 'Parolalar eşleşmiyor.';
                errorDiv.classList.remove('d-none');
                return;
            }
        } else if (passwordConfirm) {
            errorDiv.textContent = 'Parola tekrarı için yeni parola girmelisiniz.';
            errorDiv.classList.remove('d-none');
            return;
        }
        
        const phoneValue = editPhoneInput.value.replace(/\D/g, '');
        const phone = phoneValue.length === 10 ? '+90' + phoneValue : (phoneValue.length === 0 ? null : phoneValue);
        
        if (phoneValue.length > 0 && phoneValue.length !== 10) {
            errorDiv.textContent = 'Telefon numarası 10 haneli olmalıdır.';
            errorDiv.classList.remove('d-none');
            return;
        }
        
        const formData = new FormData(this);
        if (phone) {
            formData.set('phone', phone);
        } else {
            formData.set('phone', '');
        }
        
        fetch('/view/profile/update', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                successDiv.textContent = 'Profil başarıyla güncellendi!';
                successDiv.classList.remove('d-none');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                return response.text().then(text => {
                    errorDiv.textContent = text || 'Bir hata oluştu.';
                    errorDiv.classList.remove('d-none');
                });
            }
        })
        .catch(error => {
            errorDiv.textContent = 'Bir hata oluştu. Lütfen tekrar deneyin.';
            errorDiv.classList.remove('d-none');
        });
    });
</script>
</body>
</html>
