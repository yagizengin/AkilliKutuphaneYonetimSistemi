<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kayıt Ol</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/variables.css}">
    <link rel="stylesheet" th:href="@{/css/auth.css}">
    <style>
        .auth-card { max-width: 450px; }
        .alert { margin-top: 1rem; }
    </style>
</head>
<body class="auth-container">
<div class="auth-card shadow-lg">
    <div class="auth-card-header p-4 text-center">
        <h4 class="fw-semibold mb-0">
            <i class="fas fa-user-plus me-2"></i>Kayıt Ol
        </h4>
    </div>
    <div class="card-body p-4">
        <form id="registerForm" class="needs-validation" novalidate>
            <div class="mb-3">
                <label for="fullName" class="form-label">Ad Soyad <span class="text-danger">*</span></label>
                <input class="form-control" type="text" id="fullName" name="fullName" required 
                       placeholder="Adınız ve soyadınız">
                <div class="invalid-feedback">Lütfen ad soyad giriniz.</div>
            </div>
            
            <div class="mb-3">
                <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                <input class="form-control" type="email" id="email" name="email" required 
                       placeholder="ornek@email.com">
                <div class="invalid-feedback">Geçerli bir email adresi giriniz.</div>
            </div>
            
            <div class="mb-3">
                <label for="phone" class="form-label">Telefon</label>
                <div class="input-group">
                    <span class="input-group-text" style="background: #0b1224 !important; border: 1px solid rgba(255,255,255,0.12) !important; color: #f8fafc !important; border-right: none;">+90</span>
                    <input class="form-control" type="tel" id="phone" name="phone" 
                           placeholder="123 456 78 90" maxlength="17"
                           style="background: #0b1224 !important; border-left: none; padding-left: 0; color: #f8fafc !important;">
                </div>
                <div class="invalid-feedback">Telefon numarası 10 haneli olmalıdır.</div>
                <small class="text-muted">10 haneli telefon numaranızı giriniz (örn: 123 456 78 90)</small>
            </div>
            
            <div class="mb-3">
                <label for="password" class="form-label">Parola <span class="text-danger">*</span></label>
                <input class="form-control" type="password" id="password" name="password" required 
                       placeholder="En az 6 karakter" minlength="6">
                <div class="invalid-feedback">Parola en az 6 karakter olmalıdır.</div>
            </div>
            
            <div class="mb-3">
                <label for="passwordConfirm" class="form-label">Parola Tekrar <span class="text-danger">*</span></label>
                <input class="form-control" type="password" id="passwordConfirm" name="passwordConfirm" required 
                       placeholder="Parolanızı tekrar giriniz">
                <div class="invalid-feedback">Parolalar eşleşmelidir.</div>
            </div>
            
            <button class="btn btn-primary w-100 mb-3" type="submit">
                <i class="fas fa-user-plus me-2"></i>Kayıt Ol
            </button>
            
            <div class="text-center">
                <small class="text-light opacity-75">
                    Zaten hesabınız var mı? 
                    <a href="/login" class="login-link">Giriş yap</a>
                </small>
            </div>
        </form>
        
        <div id="errorMessage" class="alert alert-danger d-none mt-3" role="alert"></div>
        <div id="successMessage" class="alert alert-success d-none mt-3" role="alert"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const password = document.getElementById('password');
    const passwordConfirm = document.getElementById('passwordConfirm');
    
    function validatePasswordMatch() {
        if (passwordConfirm.value !== '') {
            if (password.value !== passwordConfirm.value) {
                passwordConfirm.setCustomValidity('Parolalar eşleşmiyor');
            } else {
                passwordConfirm.setCustomValidity('');
            }
        }
    }
    
    password.addEventListener('input', validatePasswordMatch);
    passwordConfirm.addEventListener('input', validatePasswordMatch);
    
    const phoneInput = document.getElementById('phone');
    
    function formatPhoneNumber(value) {
        const digits = value.replace(/\D/g, '');
        
        const limitedDigits = digits.slice(0, 10);
        
        if (limitedDigits.length <= 3) {
            return limitedDigits;
        } else if (limitedDigits.length <= 6) {
            return limitedDigits.slice(0, 3) + ' ' + limitedDigits.slice(3);
        } else if (limitedDigits.length <= 8) {
            return limitedDigits.slice(0, 3) + ' ' + limitedDigits.slice(3, 6) + ' ' + limitedDigits.slice(6);
        } else {
            return limitedDigits.slice(0, 3) + ' ' + limitedDigits.slice(3, 6) + ' ' + limitedDigits.slice(6, 8) + ' ' + limitedDigits.slice(8);
        }
    }
    
    phoneInput.addEventListener('input', function(e) {
        const formatted = formatPhoneNumber(e.target.value);
        e.target.value = formatted;
        
        const digits = e.target.value.replace(/\D/g, '');
        if (digits.length === 10) {
            e.target.setCustomValidity('');
            e.target.classList.add('is-valid');
            e.target.classList.remove('is-invalid');
        } else if (digits.length > 0) {
            e.target.setCustomValidity('Telefon numarası 10 haneli olmalıdır.');
            e.target.classList.add('is-invalid');
            e.target.classList.remove('is-valid');
        } else {
            e.target.setCustomValidity('');
            e.target.classList.remove('is-invalid');
            e.target.classList.remove('is-valid');
        }
    });
    
    phoneInput.addEventListener('blur', function(e) {
        const digits = e.target.value.replace(/\D/g, '');
        if (digits.length > 0 && digits.length !== 10) {
            e.target.setCustomValidity('Telefon numarası 10 haneli olmalıdır.');
            e.target.classList.add('is-invalid');
            e.target.classList.remove('is-valid');
        } else if (digits.length === 10) {
            e.target.setCustomValidity('');
            e.target.classList.add('is-valid');
            e.target.classList.remove('is-invalid');
        } else {
            e.target.setCustomValidity('');
            e.target.classList.remove('is-invalid');
            e.target.classList.remove('is-valid');
        }
    });
    
    document.getElementById('registerForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!this.checkValidity()) {
            e.stopPropagation();
            this.classList.add('was-validated');
            return;
        }
        
        const phoneValue = document.getElementById('phone').value.replace(/\D/g, '');
        const phone = phoneValue.length === 10 ? '+90' + phoneValue : null;
        
        const formData = {
            fullName: document.getElementById('fullName').value,
            email: document.getElementById('email').value,
            phone: phone,
            password: document.getElementById('password').value,
            passwordConfirm: document.getElementById('passwordConfirm').value
        };
        
        if (phoneValue.length > 0 && phoneValue.length !== 10) {
            errorDiv.textContent = 'Telefon numarası 10 haneli olmalıdır.';
            errorDiv.classList.remove('d-none');
            return;
        }
        
        const errorDiv = document.getElementById('errorMessage');
        const successDiv = document.getElementById('successMessage');
        
        errorDiv.classList.add('d-none');
        successDiv.classList.add('d-none');
        
        if (formData.password !== formData.passwordConfirm) {
            errorDiv.textContent = 'Parolalar eşleşmiyor.';
            errorDiv.classList.remove('d-none');
            return;
        }
        
        if (formData.password.length < 6) {
            errorDiv.textContent = 'Parola en az 6 karakter olmalıdır.';
            errorDiv.classList.remove('d-none');
            return;
        }
        
        try {
            const response = await fetch('/api/auth/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();
            
            if (response.ok) {
                successDiv.textContent = 'Kayıt başarılı! Giriş sayfasına yönlendiriliyorsunuz...';
                successDiv.classList.remove('d-none');
                setTimeout(() => {
                    window.location.href = '/login?registered=true';
                }, 2000);
            } else {
                errorDiv.textContent = data.error || 'Kayıt sırasında bir hata oluştu. Lütfen tekrar deneyin.';
                errorDiv.classList.remove('d-none');
            }
        } catch (error) {
            errorDiv.textContent = 'Bir hata oluştu. Lütfen tekrar deneyin.';
            errorDiv.classList.remove('d-none');
        }
    });
</script>
</body>
</html>

